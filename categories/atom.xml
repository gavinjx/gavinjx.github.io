
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>一个phper的博客</title>
	<meta name="author" content="Gavin">

	
	<meta name="description" content="2015-10-06T16:22:48+08:00 http://guojianxiang.com/ Octopress 2015-10-06T23:00:00+08:00 http://guojianxiang.com/posts/Update_OSX_EI_Captain_Problems &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="" rel="alternate" title="一个phper的博客" type="application/atom+xml">
	
	<link rel="canonical" href="http://guojianxiang.com/categories/atom.xml">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/customer.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<link href='/stylesheets/font-nunito.css' rel='stylesheet' type='text/css'>
	<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> -->
	<script src="/javascripts/jquery-1.7.2.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="/images/profile.png" alt="Profile Picture" style="width: 160px;" />
	<!-- 
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("guojianxiang@17yuea.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	 -->
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">首页</a></li>
    <li><a href="/archives/">文章</a></li>
    <li><a href="/tags/">标签</a></li>
    <li><a href="/about/">关于我</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:guojianxiang@17yuea.com" title="Email">Email</a>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
    	
    	
    	<!--  -->
	</div>
	
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[一个phper的博客]]></title>
  <link href="http://guojianxiang.com/atom.xml" rel="self"/>
  <link href="http://guojianxiang.com/"/>
  <updated>2015-10-06T16:22:48+08:00</updated>
  <id>http://guojianxiang.com/</id>
  <author>
    <name><![CDATA[Gavin]]></name>
    <email><![CDATA[guojianxiang@17yuea.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[关于 OSX 升级到 EI Captain 的解决方案]]></title>
    <link href="http://guojianxiang.com/posts/2015-10-06-Update_OSX_EI_Captain_Problems.html"/>
    <updated>2015-10-06T23:00:00+08:00</updated>
    <id>http://guojianxiang.com/posts/Update_OSX_EI_Captain_Problems</id>
    <content type="html"><![CDATA[<p>昨天把OSX升级到了 EI Captain，然后就遇到了各种奇怪问题。</p>

<!--more-->


<ul>
<li><p>刚开始只是发现QQ变成英文了 => 没问题，重新安装了一遍好了&hellip;</p></li>
<li><p>然后下午发现 Sequel 连接不到远程服务器，发现是 ssh 无法使用公钥的问题，删除<code>~/.ssh/known_hosts</code>（已经提前备份）后，发现还是不可以，重装后依然不行。最后下载了更高版本的 Sequel 没问题了&hellip;</p></li>
<li><p>后来要更新blog的时候，发现ruby不能使用，（ 因为blog使用的是Octopress ），ruby各种报权限不足的Error，什么鬼？</p></li>
</ul>


<p>查看了下EI Captain的更新说明，原来是<code>Rootless</code>惹的祸：</p>

<blockquote><p>一句话总结，即使是root用户，将无法对以下路径有写和执行权限：</p>

<p>/System</p>

<p>/bin</p>

<p>/sbin</p>

<p>/usr (except /usr/local)</p>

<p>只有Apple自身签名的软件（含命令行工具）可以。</p></blockquote>

<p>尝试关掉<code>Rootless</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gavin:octopress gavin<span class="nv">$ </span>sudo nvram boot-args<span class="o">=</span><span class="s2">&quot;kext-dev-mode=1 rootless=0&quot;</span><span class="p">;</span>sudo reboot
</span></code></pre></td></tr></table></div></figure>


<p>重启后依然不行，再更新下 CommandLine Tool，新版本的XCode竟然把之前的CommandLine Tool删除了，从官网下载后进行了安装。</p>

<p>然后自定义GEM_HOME：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#Add For Custom Ruby</span>
</span><span class='line'><span class="nb">export </span><span class="nv">GEM_HOME</span><span class="o">=</span>/data/app/ruby
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GEM_HOME</span>/bin
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gavin:octopress gavin<span class="nv">$ </span>gem update
</span><span class='line'>gavin:octopress gavin<span class="nv">$ </span>gem install bundler
</span><span class='line'>gavin:octopress gavin<span class="nv">$ </span>bundle install <span class="c"># install RedCloth</span>
</span><span class='line'>gavin:octopress gavin<span class="nv">$ </span>gem install jekyll
</span><span class='line'>gavin:octopress gavin<span class="nv">$ </span>gem install compass
</span><span class='line'>gavin:octopress gavin<span class="nv">$ </span>rake generate
</span></code></pre></td></tr></table></div></figure>


<p>Success!</p>

<p>brew也受到了影响，把/usr/local的权限设置成 <code>755</code>，并重新update
update过程中会报错：brew update failure while executing git checkout
执行以下命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> <span class="sb">`</span>brew --prefix<span class="sb">`</span>
</span><span class='line'><span class="nv">$ </span>git remote add origin https://github.com/Homebrew/homebrew.git
</span><span class='line'><span class="nv">$ </span>git fetch origin
</span><span class='line'><span class="nv">$ </span>git reset --hard origin/master
</span><span class='line'><span class="nv">$ </span>brew update
</span></code></pre></td></tr></table></div></figure>


<p>新机制Rootless出现后，很多软件安装都不能放到<code>/usr</code>下了，重新改变软件路径就可以了。</p>

<p>[参考资料]</p>

<ol>
<li><p><a href="http://www.zhihu.com/question/31116473">在 OS X 10.11 中引入的 Rootless 是如何实现的？有什么优势与缺陷？</a></p></li>
<li><p><a href="http://stackoverflow.com/questions/9370552/brew-update-failure-while-executing-git-checkout">brew update failure while executing git checkout</a></p></li>
<li><p><a href="http://segmentfault.com/q/1010000002926243">安装Cocoapods，更新gem出现的问题</a></p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[不同系统间的账户登录-Cookie跨域]]></title>
    <link href="http://guojianxiang.com/posts/2015-09-15-Diff_System_Account_Sync.html"/>
    <updated>2015-09-15T23:30:00+08:00</updated>
    <id>http://guojianxiang.com/posts/Diff_System_Account_Sync</id>
    <content type="html"><![CDATA[<blockquote><p>这两天在做：让两个系统间的帐号同步，其中涉及到跨域登录.</p></blockquote>

<!-- more -->


<p>背景是这样的：现在有两个系统SystemA和SystemB，要求在SystemA里可以注册SystemB的帐号，同时注册SystemB的时候需要依赖一个新的SystemA的帐号，并且要求在登录SystemB的时候同时登录SystemA的新帐号，并且在同一个浏览器内可以同时登录SystemA的初始帐号SA，SystemB的帐号SB和SystemA的新帐号SAN.</p>

<p>系统SystemA和SystemB都是采用Cookie记录登录操作的. 因此需要同时有SA, SB, SAN三者的Cookie.</p>

<p>解决方案是：使用三个域名（<code>abc.com</code>, <code>sb.abc.com</code>, <code>newsa.abc.com</code>）,其中SA访问<code>abc.com</code>进行登录, SAN访问<code>newsa.abc.com</code>进行登录, SB访问<code>sb.abc.com</code>进行登录. 其中<code>abc.com</code>和<code>newsa.abc.com</code>都指向SystemA, <code>sb.abc.com</code>指向SystemB. 这样SA登录的时候使用域<code>abc.com</code>的Cookie, SAN登录的时候使用<code>newsa.abc.com</code>的Cookie, SB登录的时候使用<code>sb.abc.com</code>的Cookie.</p>

<ul>
<li>跨域登录：其实很简单，首先使用SA登录<code>abc.com</code>，这时候已经种植了<code>abc.com</code>的Cookie, 然后用SB登录SystemB成功后种植了<code>sb.abc.com</code>的Cookie, 登录SystemB的时候动态生成一个script，该script的src指向<code>newsa.abc.com</code>的一个URL，该URL负责种植域<code>newsa.abc.com</code>下的Cookie（也就是采用动态载入异域的script解决跨域）.</li>
</ul>


<p>在<code>sb.abc.com</code>的登录页面ajax验证登录成功后执行下面的代码，动态引入<code>newsa.abc.com</code>的一个URL作为dom-script.</p>

<blockquote><p>你可能会问为什么不在<code>sb.abc.com</code>直接种植<code>newsa.abc.com</code>下的Cookie呢？</p>

<p>因为种不了，这属于跨域了. sb.abc.com可以种植sb.abc.com和abc.com下的Cookie, 无法在同级别的二级域名下种植Cookie.</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">loadScript</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">callbackData</span><span class="p">){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">script</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span> <span class="c1">//IE </span>
</span><span class='line'>      <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="s2">&quot;loaded&quot;</span> <span class="o">||</span>
</span><span class='line'>              <span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span><span class="p">){</span>
</span><span class='line'>              <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>              <span class="nx">callback</span><span class="p">(</span><span class="nx">callbackData</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//Others: Firefox, Safari, Chrome, and Opera </span>
</span><span class='line'>      <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="nx">callback</span><span class="p">(</span><span class="nx">callbackData</span><span class="p">);</span>   
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</span><span class='line'>  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">loadScript</span><span class="p">(</span><span class="s1">&#39;http://newsa.abc.com/project/setcookie&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">callbackData</span><span class="p">)</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>嗯，还支持简单的回调 ~</p>

<ul>
<li>父域和子域Cookie的发送优先级</li>
</ul>


<p>没错，通过上面的异步引入<code>newsa.abc.com</code>一个种植Cookie的URL我们可以成功种植Cookie.</p>

<p>But, 当我们访问<code>newsa.abc.com</code>的时候发现浏览器在Header里发送的不是 <code>newsa.abc.com</code>的Cookie, 而是<code>abc.com</code>的Cookie. 即当父域和子域的Cookie同时存在时访问子域的URL，浏览器会优先发送父域的Cookie.</p>

<p>我们翻阅下种植Cookie的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nx">bool</span> <span class="nb">setcookie</span> <span class="p">(</span> <span class="nx">string</span> <span class="nv">$name</span> <span class="p">[,</span> <span class="nx">string</span> <span class="nv">$value</span> <span class="p">[,</span> <span class="nx">int</span> <span class="nv">$expire</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">[,</span> <span class="nx">string</span> <span class="nv">$path</span> <span class="p">[,</span> <span class="nx">string</span> <span class="nv">$domain</span> <span class="p">[,</span> <span class="nx">bool</span> <span class="nv">$secure</span> <span class="o">=</span> <span class="k">false</span> <span class="p">[,</span> <span class="nx">bool</span> <span class="nv">$httponly</span> <span class="o">=</span> <span class="k">false</span> <span class="p">]]]]]]</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>path</code> 就是我们解决问题的关键，由于项目正好不是在域名下的<code>'/'根目录</code>，所以对于子域的Cookie, 我们种植到项目目录下，父域的Cookie还是种植到<code>'/'根目录</code>, 假设项目目录为：<code>/project</code>，当访问<code>abc.com/project</code>下的URI时，发送的是<code>abc.com</code>的Cookie, 访问<code>newsa.abc.com/project</code>的URI时，发送的是<code>newsa.abc.com</code>的Cookie（因为我们设置了newsa.abc.com的Cookie的path，所以优先发送. ）</p>

<p>当然我们完全可以将<code>newsa.abc.com</code>替换成<code>def.com</code>，这样就不涉及子域，父域的Cookie共享问题了，但是我们有自己的业务考虑，使用<code>newsa.abc.com</code>对用户来说更能体现我们业务的紧密型.</p>

<p><br></p>

<p>总结下Cookie的跨域共享：</p>

<ol>
<li>在可读取的path下子域可以共享父域的Cookie，同时如果二者都存在，优先使用匹配当前path的Cookie.</li>
<li>不同的子域之间不能种植Cookie.</li>
<li>子域可以种植父域的Cookie.</li>
<li>父域不可以种植子域的Cookie.</li>
<li>父域不可以共享子域的Cookie.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[树莓派控制有源蜂鸣器]]></title>
    <link href="http://guojianxiang.com/posts/2015-09-06-RP_Controle_FMQ.html"/>
    <updated>2015-09-06T23:17:00+08:00</updated>
    <id>http://guojianxiang.com/posts/RP_Controle_FMQ</id>
    <content type="html"><![CDATA[<blockquote><p>前几天淘的温湿度传感器和有源蜂鸣器今天终于到了，今晚10点半左右就整起来了.</p></blockquote>

<!--more-->


<p>大学里学的电路图早已忘的一干二净，听起来实现起来有点难度的样子.</p>

<p>5V有源蜂鸣器 电磁式（SOT塑封管 长声 ）属性：</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>属性</th>
</tr>
</thead>
<tbody>
<tr>
<td>电压</td>
<td> 3.5—5.5V</td>
</tr>
<tr>
<td>电流</td>
<td>  &lt;25mA</td>
</tr>
<tr>
<td>频率</td>
<td>  2300±500</td>
</tr>
</tbody>
</table>


<p>关于有源蜂鸣器和无源蜂鸣器的区别：</p>

<blockquote><p>无源蜂鸣器：</p>

<ol>
<li><p>无源内部不带震荡源，所以如果用直流信号无法令其鸣叫，必须用2K~5K的方波去驱动它.</p></li>
<li><p>声音频率可控，可以做出“多来米发索拉西”的效果.</p></li>
<li><p>在一些特例中，可以和LED复用一个控制口.</p></li>
</ol>


<p>有源蜂鸣器：</p>

<ol>
<li><p>有源蜂鸣器内部带震荡源，所以只要一通电就会叫.</p></li>
<li><p>程序控制方便，单片机一个高低电平就可以让其发出声音，而无源蜂鸣器却做不到.</p></li>
</ol>
</blockquote>

<ul>
<li>首先找来了树莓派的接口图（我的小派是二代的）：</li>
</ul>


<p><img src="http://guojianxiang.com/images/pi_io.png" alt="树莓派接口图" /></p>

<ul>
<li>找来淘宝的蜂鸣器图片介绍：</li>
</ul>


<p><img src="http://guojianxiang.com/images/fengmingqi_io.png" alt="有源蜂鸣器结构图" /></p>

<p><img src="http://guojianxiang.com/images/fengmingqi_io_shiwu.png" alt="有源蜂鸣器结构图" /></p>

<p>标有 <code>+</code> 的就是蜂鸣器的正极，所以当把正极接到5V接口上，并把另一个接口接到随便一个IO口上时，有源蜂鸣器便正常工作了，如下图所示，黑线接的是正极，接到2口上，白线接到9口GPIO4上：</p>

<p><img src="http://guojianxiang.com/images/fengmingqi_changxiang.jpg" alt="有源蜂鸣器长响，正常工作图" /></p>

<ul>
<li>证明蜂鸣器没有问题后，接下来就考虑怎么用python控制蜂鸣器了</li>
</ul>


<p>步骤和网上的差不多，我改了下程序：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@raspberrypi:/data/python/chuanganqi# vim libbeep.py
</span></code></pre></td></tr></table></div></figure>


<p>插入如下代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="kn">as</span> <span class="nn">GPIO</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="n">PIN_NO</span> <span class="o">=</span> <span class="mi">12</span>
</span><span class='line'><span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>
</span><span class='line'><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">PIN_NO</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">beep</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
</span><span class='line'>     <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">PIN_NO</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">HIGH</span><span class="p">)</span>
</span><span class='line'>     <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
</span><span class='line'>     <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">PIN_NO</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">beepAction</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="n">sleepsecs</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span><span class='line'>        <span class="n">beep</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span>
</span><span class='line'>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleepsecs</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@raspberrypi:/data/python/chuanganqi# vim alarm.py
</span></code></pre></td></tr></table></div></figure>


<p>插入如下代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="kn">as</span> <span class="nn">GPIO</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">libbeep</span>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;continued&quot;</span>
</span><span class='line'>        <span class="n">libbeep</span><span class="o">.</span><span class="n">beepAction</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后执行 <code>alarm.py</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@raspberrypi:/data/python/chuanganqi# python alarm.py
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>libbeep.py</code>里<code>PIN_NO = 12</code>代表的是channel，针脚值</p>

<p>杜邦线插入的位置如下：</p>

<p><img src="http://guojianxiang.com/images/fengmingqi_channel.jpg" alt="有源蜂鸣器python引脚图" /></p>

<p>这样每隔三秒，蜂鸣器会报两次，听着爽爽的~</p>

<p><br>
环境准备：</p>

<ol>
<li><p><a href="https://item.taobao.com/item.htm?spm=2013.1.0.0.UqdfpT&amp;id=43751062868&amp;source=superboss&amp;appId=113">二代树莓派一个</a></p></li>
<li><p><a href="https://detail.tmall.com/item.htm?id=41231486727&amp;spm=a1z09.2.0.0.wRRwkT&amp;_u=6mh7bd0688f">有源蜂鸣器一个</a></p></li>
<li><p><a href="https://detail.tmall.com/item.htm?id=41254478179&amp;spm=a1z09.2.0.0.y3wVBD&amp;_u=6mh7bd0d7e0">杜邦线两根</a> 我买的一沓，40根</p></li>
</ol>


<p><code>观月堂</code>的小π还可以，配件就算了，相对别家来说有点贵，所以选了<code>telesky</code></p>

<p><br>
参考资料：</p>

<ol>
<li><p><a href="http://www.eeboard.com/bbs/forum.php?mod=viewthread&amp;tid=39728">树莓派用蜂鸣器实现整点报时</a></p></li>
<li><p><a href="http://www.eefocus.com/nightseas/blog/15-07/315199_48b6a.html">硬件篇（一）DIY一个树莓派扩展板</a></p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP调试工具-Xdebug]]></title>
    <link href="http://guojianxiang.com/posts/2015-09-06-PHP_Debug_Tool-Xdebug.html"/>
    <updated>2015-09-06T23:00:00+08:00</updated>
    <id>http://guojianxiang.com/posts/PHP_Debug_Tool-Xdebug</id>
    <content type="html"><![CDATA[<blockquote><p>刚刚过完了三天的小长假，假期没事的时候整理了一下Xdebug的使用. 在测试服务器上装上也方便大家调试，提高大家的编码效率.</p></blockquote>

<!--more-->


<p>先解释下xdebug等工作原理：</p>

<p>进行xdebug调试，我们需要xdebug客户端和xdebug服务端，编译到php的就是服务端，客户端一般需要我们自己安装（像sublime text），或者一般的IDE都已经集成.</p>

<p>当我们进行xdebug调试时，首先客户端会监听一个端口，然后等待xdebug服务端连接，连接成功则进行通信.如下图所示：</p>

<p><img src="http://guojianxiang.com/images/php/xdebug/dbgp-setup.gif" alt="原理图" /></p>

<p>本机的IP(也就是IDE的IP)是10.0.1.42，监听的是本机的9000端口；
服务器的IP是10.0.1.2，连接的是80端口（web服务器默认端口）；</p>

<p>所以在<code>php.ini</code>里我们的配置应该是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>xdebug.remote_host<span class="o">=</span>10.0.1.42
</span><span class='line'>xdebug.remote_port<span class="o">=</span><span class="m">9000</span>
</span></code></pre></td></tr></table></div></figure>


<p>(PS：如果本机开着php并运行在9000端口上，应该换一个端口)</p>

<p>其中<code>remote_host</code> 就是xdebug服务器回调客户端的IP，也就是你进行xdebug调试的机器的IP</p>

<blockquote><p>但是当我们有很多人进行远程调试的时候，这个<code>remote_host</code>不能动态变化，这样就没法满足所有人的调试需求了？</p></blockquote>

<p>解决方法：在xdebug服务端有一个配置<code>xdebug.remote_connect_back</code>，这个值一旦设定为1就可以解决IP不是remote_host中值无法调试的问题，xdebug服务端可以从http请求的头部<code>$_SERVER['REMOTE_ADDR']</code>获取远程客户端的IP地址，如下图：</p>

<p><img src="http://guojianxiang.com/images/php/xdebug/dbgp-setup2.gif" alt="原理图" /></p>

<ul>
<li>好了，讲完原理，我们看下怎么编译服务端的：</li>
</ul>


<p>从官网wget编译文件，解压安装包</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@web4 software<span class="o">]</span><span class="c"># tar -zvxf xdebug-2.3.3.tgz</span>
</span><span class='line'><span class="o">[</span>root@web4 software<span class="o">]</span><span class="c"># cd xdebug-2.3.3</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中 <code>README</code> 中有关于安装的详细步骤，我的php安装路径为：/data/app/php</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@web4 xdebug-2.3.3<span class="o">]</span><span class="c"># /data/app/php/bin/phpize</span>
</span><span class='line'><span class="o">[</span>root@web4 xdebug-2.3.3<span class="o">]</span><span class="c"># ./configure --enable-xdebug --with-php-config=/data/app/php/bin/php-config</span>
</span><span class='line'>make <span class="o">&amp;&amp;</span> make install
</span></code></pre></td></tr></table></div></figure>


<p>配置php.ini</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>xdebug<span class="o">]</span>
</span><span class='line'><span class="nv">zend_extension</span><span class="o">=</span><span class="s2">&quot;xdebug.so&quot;</span>
</span><span class='line'>xdebug.auto_trace<span class="o">=</span><span class="nb">true</span>
</span><span class='line'>xdebug.remote_enable<span class="o">=</span>1
</span><span class='line'>xdebug.remote_autostart<span class="o">=</span>1
</span><span class='line'>xdebug.remote_handler<span class="o">=</span>dbgp
</span><span class='line'>xdebug.remote_host<span class="o">=</span>192.168.0.116
</span><span class='line'>xdebug.remote_connect_back<span class="o">=</span>1
</span><span class='line'>xdebug.remote_port<span class="o">=</span>9090
</span><span class='line'>xdebug.idekey<span class="o">=</span>web
</span><span class='line'>xdebug.remote_log<span class="o">=</span><span class="s2">&quot;/data/app/php/var/log/xdebug/xdebug.log&quot;</span>
</span><span class='line'>xdebug.profiler_enable<span class="o">=</span>1
</span><span class='line'>xdebug.profiler_output_dir<span class="o">=</span><span class="s2">&quot;/data/app/php/var/log/xdebug/xdebug-profiler&quot;</span>
</span><span class='line'><span class="p">;</span>xdebug.dump_once <span class="o">=</span> On
</span><span class='line'><span class="p">;</span>xdebug.dump_globals <span class="o">=</span> On
</span><span class='line'><span class="p">;</span>xdebug.dump_undefined <span class="o">=</span> On
</span><span class='line'><span class="p">;</span>xdebug.dump.SERVER <span class="o">=</span> REQUEST_METHOD,REQUEST_URI,HTTP_USER_AGENT
</span><span class='line'><span class="p">;</span>xdebug.dump.REQUEST<span class="o">=</span>*
</span><span class='line'><span class="p">;</span>xdebug.show_exception_trace <span class="o">=</span> On
</span><span class='line'><span class="p">;</span>xdebug.show_local_vars <span class="o">=</span> <span class="m">1</span>
</span><span class='line'><span class="p">;</span>xdebug.var_display_max_depth <span class="o">=</span> <span class="m">6</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>现在用sublime text3来说下怎么配置客户端</li>
</ul>


<p>安装 package <code>Xdebug Client</code></p>

<p>新建一个 project 并且执行 <code>项目=&gt;项目另存为</code>,并且已经成功设置 sftp</p>

<p>编辑存储后的project文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;folders&quot;</span><span class="p">:</span>
</span><span class='line'>  <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/MyLocalProjectPath/xdebug&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;xdebug&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://RemoteAddr/xdebug/index.php&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;path_mapping&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;/MyLocalProjectPath/xdebug/&quot;</span> <span class="p">:</span> <span class="s2">&quot;/RemoteProjectLocation/xdebug/&quot;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="nt">&quot;ide_key&quot;</span><span class="p">:</span> <span class="s2">&quot;web&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;super_globals&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;close_on_stop&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">9090</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>新加入的代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;settings&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;xdebug&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://RemoteAddr/xdebug/index.php&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;path_mapping&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;/MyLocalProjectPath/xdebug/&quot;</span> <span class="p">:</span> <span class="s2">&quot;/RemoteProjectLocation/xdebug/&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;ide_key&quot;</span><span class="p">:</span> <span class="s2">&quot;web&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;super_globals&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;close_on_stop&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">9090</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是在本机进行调试，可以这样设置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;settings&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;xdebug&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost/xdebug&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>记得重启php-fpm</strong></p>

<p>配置完毕！可以设置断点调试了~</p>

<hr />

<p>更新：</p>

<p>sublime text不支持多人调试的模式，经测试发现设置了<code>remote_connect_back=1</code>并注释掉<code>remote_host</code>后，sublime text无法与xdebug服务器进行通信，后来发现是需要 <a href="http://derickrethans.nl/debugging-with-multiple-users.html">DBGp代理</a>的.</p>

<p>一般的IDE是集成的，并且sublime text xdebug界面也不是很友好，如果需要debug的时候感觉phpstorm比较顺手.</p>

<p>对于 调试 Zendframework 也有了比较好的方法，由于Zendframework是做过路由的，因此没法进行 map 对应，之前看过一篇文章说的是在debug的时候做路由映射，我可能比较懒吧，想到了另一种方法：</p>

<p>我们只设置一个 debug 文件，需要对 某个action进行debug的时候只需要引入这个controller，new 一个 controller 类，然后调用对应的action即可，经过测试，在action里的变量可以在debug文件中进行debug时完全可以捕获！</p>

<p>[参考资料]</p>

<ol>
<li><p><a href="http://www.xdebug.org/docs/remote">官方文档</a></p></li>
<li><p><a href="https://packagecontrol.io/packages/Xdebug%20Client">SublimeTextXdebug</a></p></li>
<li><p><a href="http://www.jetbrains.com/phpstorm/help/configuring-xdebug.html">PhpStorm 9.0.0 Help/Configuring Xdebug</a></p></li>
<li><p><a href="http://blog.csdn.net/yaoyuan_difang/article/details/11656759">使用netbeans进行PHP团队开发和基于xdebug进行多人远程调试</a></p></li>
<li><p><a href="http://www.sitepoint.com/debugging-xdebug-sublime-text-3/">Debugging with Xdebug and Sublime Text 3</a></p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP调试工具-Strace]]></title>
    <link href="http://guojianxiang.com/posts/2015-09-06-PHP_Debug_Tool_Strace.html"/>
    <updated>2015-09-06T13:35:00+08:00</updated>
    <id>http://guojianxiang.com/posts/PHP_Debug_Tool_Strace</id>
    <content type="html"><![CDATA[<blockquote><p>昨天的时候，刚好看了下php调试方面的东西，正好看到了Strace，没想到今天就用上了.</p></blockquote>

<!--more-->


<p>今天，补单程序突然出现bug，有两笔订单掉单了却没有补单成功.</p>

<ul>
<li>首先，查了下 补单脚本</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ps -ef<span class="p">|</span>grep Patch
</span><span class='line'>xx      <span class="m">32687</span>  <span class="m">3224</span>  <span class="m">0</span> Aug20 ?        00:00:48 ...
</span></code></pre></td></tr></table></div></figure>


<p>补单脚本是守护进程控制的，但是看到这个时间点 <code>Aug20</code>，说明8.20日之后，脚本没有自动关闭，一直在执行. 所以就想看看是什么原因导致了脚本一直执行而没有退出.</p>

<ul>
<li>使用 <code>Strace</code> 命令</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>strace -p 32687
</span><span class='line'>
</span><span class='line'>restart_syscall<span class="o">(</span>&lt;... resuming interrupted call ...&gt;<span class="o">)</span> <span class="o">=</span> 0
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 1000<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 1000<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 1000<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 1000<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 0<span class="o">)</span> <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Timeout<span class="o">)</span>
</span><span class='line'>poll<span class="o">([{</span><span class="nv">fd</span><span class="o">=</span>5, <span class="nv">events</span><span class="o">=</span>POLLIN<span class="p">|</span>POLLPRI<span class="p">|</span>POLLRDNORM<span class="p">|</span>POLLRDBAND<span class="o">}]</span>, 1, 1000^C &lt;unfinished ...&gt;
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，程序一直卡在curl超时上，然后检查了下补单相关的 curl 操作，发现大多数的 curl 没有加入连接超时时间，当DNS出现问题时，一直在等待服务器的回应，导致脚本调用的时候卡死.</p>

<p>总结一下：Strace 还有很多用法，比如查看一段时间内调用系统函数最多的统计等等，<code>strace -p 进程ID</code> 是查看该进程的系统函数调用情况，对于异步脚本很有用！ 很多strace的用法以后会再更新~</p>

<h2><br></h2>

<p>参考资料：</p>

<ol>
<li><a href="http://www.dewen.io/q/17309/php+curl%E8%B0%83%E7%94%A8%E7%9A%84%E6%97%B6%E5%80%99%E5%8D%A1%E6%AD%BB%EF%BC%8Cstrace%E7%BB%93%E6%9E%9C%E5%A6%82%E5%86%85">php curl调用的时候卡死，strace结果如内</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于 HttpStatus 200（From Cache）和 304（Not Modified）的探索]]></title>
    <link href="http://guojianxiang.com/posts/2015-09-01-About_HttpStatus200_FromCache_And_304_NotModified.html"/>
    <updated>2015-09-01T23:00:00+08:00</updated>
    <id>http://guojianxiang.com/posts/About_HttpStatus200_FromCache_And_304_NotModified</id>
    <content type="html"><![CDATA[<p>今晚走了很长时间的弯路，最后发现问题在于 <strong>url load 访问</strong> 和 <strong>Command+R</strong> 刷新上，道路曲折但是很有意思。</p>

<blockquote><p>问题的起源在于晚上把一个demo部署到阿里云上，在配置nginx的时候，设置了expire。但是当用Chrome检查Network的时候，发现已经设置了expire的css，js，image 总是返回304（Not Modified）的状态。因为之前服务器缓存资源出现返回304的问题，所以就打算看下到底是什么问题</p></blockquote>

<!-- more -->


<p>首先，我断定自己的expire是没有设置错的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">location</span> <span class="p">~</span> <span class="sr">.*.(css|js)$</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">expires</span> <span class="s">30d</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>于是开始查看是否是ETag的配置问题？</p>

<ul>
<li>弯路1：nginx自从1.3版本后默认带有etag，木有发现，然后去github下载第三方ETag插件编译。。。 1.3版本后可以通过设置 etag on|off实现 etag 的配置，并且默认开启etag.</li>
</ul>


<p>Web服务器我们以nginx为例，以css文件为例，ETag可以理解为一个文件的标记，是唯一的.</p>

<p>ETag的工作原理是：</p>

<ul>
<li>第一次访问， nginx会返回ETag值，浏览器会记录下来</li>
</ul>


<p>Request</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">Accept:text/css,*/*;q=0.1</span>
</span><span class='line'><span class="err">Accept-Encoding:gzip, deflate, sdch</span>
</span><span class='line'><span class="err">Accept-Language:zh-CN,zh;q=0.8,en;q=0.6</span>
</span><span class='line'><span class="err">Cache-Control:no-cache</span>
</span><span class='line'><span class="err">Connection:keep-alive</span>
</span><span class='line'><span class="err">Host:123.57.161.203:81</span>
</span><span class='line'><span class="err">Pragma:no-cache</span>
</span><span class='line'><span class="err">Referer:http://123.57.161.203:81/</span>
</span><span class='line'><span class="err">User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.6 Safari/537.36</span>
</span><span class='line'><span class="err">X-FirePHP-Version:0.0.6</span>
</span></code></pre></td></tr></table></div></figure>


<p>Response</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">Status Code:200 OK</span>
</span><span class='line'>
</span><span class='line'><span class="err">Accept-Ranges:bytes</span>
</span><span class='line'><span class="err">Cache-Control:max-age=2592000</span>
</span><span class='line'><span class="err">Connection:keep-alive</span>
</span><span class='line'><span class="err">Content-Length:32628</span>
</span><span class='line'><span class="err">Content-Type:text/css</span>
</span><span class='line'><span class="err">Date:Tue, 01 Sep 2015 14:06:27 GMT</span>
</span><span class='line'><span class="err">ETag:&quot;55e57588-7f74&quot;</span>
</span><span class='line'><span class="err">Expires:Thu, 01 Oct 2015 14:06:27 GMT</span>
</span><span class='line'><span class="err">Last-Modified:Tue, 01 Sep 2015 09:53:12 GMT</span>
</span><span class='line'><span class="err">Server:nginx/1.8.0</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>第二次访问时，浏览器会带着上次nginx返回的ETag值作为If-None-Match的值，发起请求，这时候nginx会把If-None-Match值与该页面对应的ETag值进行比较，如果不相等则返回200，重新下载资源；如果二者相等，则返回304，浏览器调用本地缓存。</li>
</ul>


<p>Request</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">Accept:text/css,*/*;q=0.1</span>
</span><span class='line'><span class="err">Accept-Encoding:gzip, deflate, sdch</span>
</span><span class='line'><span class="err">Accept-Language:zh-CN,zh;q=0.8,en;q=0.6</span>
</span><span class='line'><span class="err">Cache-Control:max-age=0</span>
</span><span class='line'><span class="err">Connection:keep-alive</span>
</span><span class='line'><span class="err">Host:123.57.161.203:81</span>
</span><span class='line'><span class="err">If-Modified-Since:Tue, 01 Sep 2015 09:53:12 GMT</span>
</span><span class='line'><span class="err">If-None-Match:&quot;55e57588-7f74&quot;</span>
</span><span class='line'><span class="err">Referer:http://123.57.161.203:81/</span>
</span><span class='line'><span class="err">User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.6 Safari/537.36</span>
</span><span class='line'><span class="err">X-FirePHP-Version:0.0.6</span>
</span></code></pre></td></tr></table></div></figure>


<p>Response</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">Status Code:304 Not Modified</span>
</span><span class='line'>
</span><span class='line'><span class="err">Cache-Control:max-age=2592000</span>
</span><span class='line'><span class="err">Connection:keep-alive</span>
</span><span class='line'><span class="err">Date:Tue, 01 Sep 2015 14:10:08 GMT</span>
</span><span class='line'><span class="err">ETag:&quot;55e57588-7f74&quot;</span>
</span><span class='line'><span class="err">Expires:Thu, 01 Oct 2015 14:10:08 GMT</span>
</span><span class='line'><span class="err">Last-Modified:Tue, 01 Sep 2015 09:53:12 GMT</span>
</span><span class='line'><span class="err">Server:nginx/1.8.0</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>但是比较纳闷的是为什么本地有缓存了，设置expire也成功了，浏览器不直接读取cache内容而是先去web服务器请求了一次？</strong></p>

<p>正常的 from cache 的 Request（应该说没有发起请求） 和 Response 应该是这样的：</p>

<p>Request</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">   -</span>
</span></code></pre></td></tr></table></div></figure>


<p>Response</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='http'><span class='line'><span class="err">Status Code:200 OK (from cache)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Accept-Ranges:bytes</span>
</span><span class='line'><span class="err">Cache-Control:max-age=2592000</span>
</span><span class='line'><span class="err">Content-Length:32628</span>
</span><span class='line'><span class="err">Content-Type:text/css</span>
</span><span class='line'><span class="err">Date:Tue, 01 Sep 2015 14:12:56 GMT</span>
</span><span class='line'><span class="err">ETag:&quot;55e57588-7f74&quot;</span>
</span><span class='line'><span class="err">Expires:Thu, 01 Oct 2015 14:12:56 GMT</span>
</span><span class='line'><span class="err">Last-Modified:Tue, 01 Sep 2015 09:53:12 GMT</span>
</span><span class='line'><span class="err">Server:nginx/1.8.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>后来看到知乎的一个问题 <a href="http://www.zhihu.com/question/28725359">阿里云存储如何让浏览器始终以200 (from cache)缓存图片</a>，里面有一句话：</p>

<blockquote><p>通过大家的回答和我自己的实验发现（Chrome上），对于阿里云的云存储，加大Cache-Control的max-age是有效的，这点我之前也试过，但是像 @yuanyuanVivian说的，是在输入URL按下回车时有效，直接刷新时图片还是无法直接加载缓存，而且无法禁用阿里云存储Etag.</p></blockquote>

<p>受到启发，终于找到问题所在了：</p>

<ul>
<li>弯路2：URL回车或者链接访问URL 与 刷新或者强制刷新（mac下的Command+R，win下的F5，Ctrl+F5等）这两种方式浏览器的处理方式是不一样的：前者操作方式，浏览器获取资源的时候不会设置 <strong>Cache-Control:max-age=0</strong>，所以如果expire设置的max-age如果仍有效的话会优先从本地cache中获取；但是后者发起Request的时候浏览器给 header 里设置的 <strong>Cache-Control:max-age=0</strong>，可以参照上文第2次访问请求。我们都知道一旦max-age为0，则不会从本地cache获取数据了，所以会发起一次http请求，nginx根据header里传来的<strong>If-Modified-Since</strong>或者<strong>If-None-Match</strong>分别与<strong>Last-Modified</strong>，<strong>Etag</strong>做对比，从而做出返回304还是200的选择，而强制刷新是将 hreader 设置为 <strong>Cache-Control:no-cache</strong>，直接返回200，下载资源.</li>
</ul>


<p>所以说 设置的 expire 是生效的。正常情况用户点链接的话，属于加载，不属于刷新，缓存的静态资源肯定会优先从本地cache获取，但是刷新的时候就避免不了一次http请求获取304了。</p>

<h2><br></h2>

<p><strong>Expire 和 ETag 都有缓存的作用，但是区别在于：</strong></p>

<ol>
<li><p>Expire 第二次访问的时候会直接从 本地cache获取，即 200（From Cache），ETag会发起一次http请求，最后返回304（Not Modified）</p></li>
<li><p>分布的问题：因为Expire第二次访问不会发起http请求，所以不存在前后资源访问不在同一台机器上的问题；但是由于每台机器在某一个时刻针对某一个资源生成ETag的值不一样，将会导致如果第二次请求分配到了另外的机器，If-None-Match与另外的服务器ETag值不对应，则重新下载资源，导致本地缓存失效！</p></li>
</ol>


<p>所以在有多台web服务器的情况下要优先使用Expire.</p>

<p>具体nginx对Expire和Etag使用优先级是什么？这个只能阅读源码，以后探索了</p>

<p>参考资料：</p>

<ol>
<li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#etag">Module ngx_http_core_module</a></li>
<li><a href="http://blog.csdn.net/21aspnet/article/details/6604789">HTTP头信息中的参数Etag</a></li>
<li><a href="http://www.bokeyy.com/post/200-ok-from-cache-vs-304-not-modified.html">200 OK (FROM CACHE) 与 304 NOT MODIFIED</a></li>
<li><a href="http://www.zhihu.com/question/28725359">阿里云存储如何让浏览器始终以200 (from cache)缓存图片？</a></li>
<li><a href="https://developer.yahoo.com/performance/rules.html">Best Practices for Speeding Up Your Web Site</a></li>
<li><a href="http://stackoverflow.com/questions/1665082/http-status-code-200-cache-vs-status-code-304">HTTP status code 200 (cache) vs status code 304?</a></li>
<li><a href="http://www-jo.se/f.pfleger/firefox-reload">Reload vs. Refresh in Firefox (Cache-Control)</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Predis和Phpredis性能测试对比]]></title>
    <link href="http://guojianxiang.com/posts/2015-05-30-Predis_VS_Phpredis.html"/>
    <updated>2015-05-30T20:20:00+08:00</updated>
    <id>http://guojianxiang.com/posts/Predis_VS_Phpredis</id>
    <content type="html"><![CDATA[<p>最近签到功能并发量有点大，php的slow log里记录的大部分日志都是关于redis的，我们线上环境是通过predis连接redis服务器的，phpredis是C预言扩展，理论上要比predis快，所以做了一下性能对比.</p>

<!-- more -->


<p>测试环境：</p>

<p><img src="http://guojianxiang.com/images/system/mac.jpg" alt="配置" /></p>

<ul>
<li>单连接本地、循环执行命令测试：</li>
</ul>


<p><em>usePredis.php</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">require</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/predis/autoload.php&#39;</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">getMillisecond</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">list</span><span class="p">(</span><span class="nv">$s1</span><span class="p">,</span> <span class="nv">$s2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;%.0f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">floatval</span><span class="p">(</span><span class="nv">$s1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">floatval</span><span class="p">(</span><span class="nv">$s2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Predis\Client</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;scheme&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;host&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;port&#39;</span>   <span class="o">=&gt;</span> <span class="mi">6379</span>
</span><span class='line'><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;gjx&#39;</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$eTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$eTime</span><span class="o">-</span><span class="nv">$sTime</span><span class="p">)</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>取三组数据：</p>

<table>
<thead>
<tr>
<th> 记录 </th>
<th> predis </th>
<th> phpredis</th>
</tr>
</thead>
<tbody>
<tr>
<td> 1 </td>
<td> 5485 </td>
<td> 3950 </td>
</tr>
<tr>
<td> 2 </td>
<td> 5343 </td>
<td> 3974 </td>
</tr>
<tr>
<td> 3 </td>
<td> 6697 </td>
<td> 3814 </td>
</tr>
</tbody>
</table>


<p>取平均数：predis：5841.7毫秒 phpredis：3912.7毫秒</p>

<p>结果：单连接本地 单命令下 phpredis比predis快1/3</p>

<ul>
<li>predis pipelining和默认模式性能对比：</li>
</ul>


<p>翻开predis的README的时候发现predis支持pipelining模式，可以一次发送多个命令不用等待回复，最后一次读取所有的回复,管道模式能有效地节约网络延迟时间，所以理论上是要比默认一个命令一次tcp请求的模式快的.
Redis是一个cs模式的tcp server，使用和http类似的请求响应协议。一个client可以通过一个socket连接发起多个请求命令。每个请求命令发出后client通常 会阻塞并等待redis服务处理，redis处理完后请求命令后会将结果通过响应报文返回给client。
当客户端用pipelining发送命令时，服务器端会在内存中使用队列存储所有的回复。如果客户端发送大量的命令，最好一次发送合理数量的命令，比如一次发送10k，然后读取回复，再发送另外的10k命令。这样可以保证每一次的速度大致相同，但是额外的内存用来存储保存着回复的队列。pipelining不能使用的情形是在客户端调用写命令前先回复读取命令。</p>

<p>1.本地 pipe VS default</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">require</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/predis/autoload.php&#39;</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">getMillisecond</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">list</span><span class="p">(</span><span class="nv">$s1</span><span class="p">,</span> <span class="nv">$s2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;%.0f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">floatval</span><span class="p">(</span><span class="nv">$s1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">floatval</span><span class="p">(</span><span class="nv">$s2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Predis\Client</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;scheme&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;host&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;port&#39;</span>   <span class="o">=&gt;</span> <span class="mi">6379</span>
</span><span class='line'><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// $result = $client-&gt;set(&#39;admin&#39;, &#39;gjx&#39;) ;</span>
</span><span class='line'>    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$eTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$eTime</span><span class="o">-</span><span class="nv">$sTime</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nv">$responses</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">pipeline</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$pipe</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// $pipe-&gt;set(&#39;admin&#39;, &#39;gjx&#39;) ;</span>
</span><span class='line'>        <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="nv">$eTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$eTime</span><span class="o">-</span><span class="nv">$sTime</span><span class="p">)</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>取三组数据：</p>

<table>
<thead>
<tr>
<th> 记录 </th>
<th> tcp </th>
<th> pipe </th>
</tr>
</thead>
<tbody>
<tr>
<td> 1 </td>
<td> 5366 </td>
<td> 1474 </td>
</tr>
<tr>
<td> 2 </td>
<td> 5587 </td>
<td> 1491 </td>
</tr>
<tr>
<td> 3 </td>
<td> 5804 </td>
<td> 1511 </td>
</tr>
</tbody>
</table>


<p>取平均数：tcp：5585.7毫秒 pipe：1492.0毫秒</p>

<p>pipe模式快于tcp将近75%，这仅仅是本机测试结果而已。</p>

<p>2.下面看看真正网络传输情况下的对比：</p>

<p>这次连接 ip为：192.168.0.210 局域网内的机器，为了能尽快的出现结果，将循环数改为10000</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">require</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/predis/autoload.php&#39;</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">getMillisecond</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">list</span><span class="p">(</span><span class="nv">$s1</span><span class="p">,</span> <span class="nv">$s2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;%.0f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">floatval</span><span class="p">(</span><span class="nv">$s1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">floatval</span><span class="p">(</span><span class="nv">$s2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Predis\Client</span><span class="p">([</span>
</span><span class='line'>    <span class="s1">&#39;scheme&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;host&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;192.168.0.210&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;port&#39;</span>   <span class="o">=&gt;</span> <span class="mi">6379</span>
</span><span class='line'><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nv">$sTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// $result = $client-&gt;set(&#39;admin&#39;, &#39;gjx&#39;) ;</span>
</span><span class='line'>    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$eTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$eTime</span><span class="o">-</span><span class="nv">$sTime</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nv">$responses</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">pipeline</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$pipe</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// $pipe-&gt;set(&#39;admin&#39;, &#39;gjx&#39;) ;</span>
</span><span class='line'>        <span class="nv">$pipe</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="nv">$eTime</span> <span class="o">=</span> <span class="nx">getMillisecond</span><span class="p">()</span> <span class="p">;</span>
</span><span class='line'><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$eTime</span><span class="o">-</span><span class="nv">$sTime</span><span class="p">)</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>取三组数据：</p>

<table>
<thead>
<tr>
<th> 记录 </th>
<th> tcp </th>
<th> pipe </th>
</tr>
</thead>
<tbody>
<tr>
<td> 1 </td>
<td> 29071 </td>
<td> 127 </td>
</tr>
<tr>
<td> 2 </td>
<td> 29540 </td>
<td> 143 </td>
</tr>
<tr>
<td> 3 </td>
<td> 29160 </td>
<td> 124 </td>
</tr>
</tbody>
</table>


<p>取平均数：tcp：29257.0毫秒 pipe：131.3毫秒</p>

<p>这次可以看出pipeling的绝对优势了！所以将互不影响的操作能够放到pipeling里能绝对的提升性能!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello World]]></title>
    <link href="http://guojianxiang.com/posts/2015-05-30-HelloWorld.html"/>
    <updated>2015-05-30T18:49:00+08:00</updated>
    <id>http://guojianxiang.com/posts/HelloWorld</id>
    <content type="html"><![CDATA[<p>Hi, This is the first page!</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">echo</span> <span class="s1">&#39;Hello World!&#39;</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Gavin
 <a target="_blank" href='http://www.miibeian.gov.cn/'>京ICP备15048929号-2</a>
<br>
Powered by <a href='https://github.com/shashankmehta/greyshade' target="_blank">GreyShade</a>

</footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'guojianxiang';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
